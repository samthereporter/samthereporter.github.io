<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation</title>
    <style>
        /* RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: #000;
            height: 100vh;
            overflow: hidden; /* Prevent scrolling */
            font-family: 'Georgia', serif;
            color: white;
        }

        /* --- LAYERS --- */

        /* LAYER 1: BACKGROUND (Bottom) */
        #bg-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #111; 
            background-image: url('images/school.jpg'); 
            background-size: cover;
            background-position: center;
            z-index: 1;
            transition: opacity 1s ease-in-out;
        }

        /* LAYER 2: STATS BAR */
        .stats-bar {
            position: absolute;
            top: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            gap: 20px;
            z-index: 10;
            font-family: sans-serif;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid #555;
        }
        .stat-value { font-weight: bold; color: #FFD700; }

        /* LAYER 3: DIALOGUE BOX CONTAINER */
        #dialogue-container {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            height: 100vh; /* Full height to allow positioning */
            z-index: 5;
            pointer-events: none; 
        }

        /* LAYER 4: CHARACTER SILHOUETTE (Behind Text Box) */
        #character-sprite {
            position: absolute;
            bottom: 0; 
            left: 5%; 
            height: 85vh; 
            width: auto;
            z-index: 5; /* LOWER than text box */
            pointer-events: none;
            filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.8));
            opacity: 0.95;
        }

        /* LAYER 5: TEXT BOX (On Top of Character) */
        .text-box-bg {
            position: absolute;
            bottom: 20px; left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 25vh;
            /* High opacity background to make text readable over the character legs */
            background: rgba(0, 0, 0, 0.9); 
            border: 2px solid #555;
            border-radius: 10px;
            /* FIXED: Removed the huge 250px left padding */
            padding: 30px 40px; 
            color: #fff;
            z-index: 10; /* HIGHER than character */
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        #story-text {
            font-size: 1.25rem;
            line-height: 1.6;
            flex-grow: 1;
            white-space: pre-wrap;
        }

        .continue-prompt {
            text-align: right;
            font-size: 0.9rem;
            color: #aaa;
            animation: blink 1.5s infinite;
            margin-top: 10px;
            visibility: hidden; 
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* CHOICES AREA */
        #choices-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); 
            z-index: 20; 
            display: none; 
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }

        .choice-btn {
            background-color: #f0f2f5;
            border: 2px solid #2c3e50;
            color: #2c3e50;
            padding: 20px 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: sans-serif;
            width: 80%;
            max-width: 600px;
            text-align: center;
            border-radius: 8px;
            pointer-events: auto; 
        }

        .choice-btn:hover {
            background-color: #2c3e50;
            color: white;
            transform: scale(1.02);
            border-color: #FFD700;
        }

        #choice-prompt-text {
            color: white; 
            margin-bottom: 30px; 
            font-size: 1.5rem;
            text-align: center;
            max-width: 80%;
        }

    </style>
</head>
<body>

    <div id="bg-layer"></div>

    <div class="stats-bar" id="statsBar" style="display:none;">
        <span>Hunger: <span id="hunger-stat" class="stat-value">50%</span></span>
        <span>Warmth: <span id="warmth-stat" class="stat-value">100%</span></span>
        <span>Spirit: <span id="spirit-stat" class="stat-value">100%</span></span>
    </div>

    <div id="dialogue-container">
        <img id="character-sprite" src="" alt="Character">
        <div class="text-box-bg">
            <div id="story-text"></div>
            <div id="continuePrompt" class="continue-prompt">Click or Press Space to continue ▼</div>
        </div>
    </div>

    <div id="choices-overlay">
        <h2 id="choice-prompt-text">Make a choice</h2>
        <div id="choices-container" style="display:flex; flex-direction:column; gap:20px; width: 100%; align-items: center;">
        </div>
    </div>


    <script>
        // --- DIAGNOSTIC TOOL ---
        function checkImage(id, filename) {
            const img = document.getElementById(id);
            img.onerror = function() {
                alert("SYSTEM ERROR: Cannot find '" + filename + "'.\nMake sure it is inside the 'images' folder!");
                img.style.border = "2px solid red"; 
            };
        }

        // --- GAME STATE ---
        let state = {
            hunger: 50, 
            warmth: 100,
            spirit: 100,
            name: localStorage.getItem('playerName') || "Student",
            gender: localStorage.getItem('playerGender') || "other",
            introIndex: 0, 
            isTyping: false, 
            inIntro: true 
        };

        const typeSpeed = 25; 
        let typeTimeouts = []; 

        // --- ASSET SETUP ---
        const charImgElement = document.getElementById('character-sprite');
        
        if (state.gender === 'female') {
            charImgElement.src = 'images/girl.png';
            checkImage('character-sprite', 'images/girl.png'); 
        } else {
            charImgElement.src = 'images/boy.png';
            checkImage('character-sprite', 'images/boy.png'); 
        }

        // --- INTRO SEQUENCE ---
        const introSequence = [
            "The year is 1970 and you, as an Indigenous person belonging to the Métis tribe, are attending Île-à-la-Crosse Residential School.",
            "Following the resistances of 1869 and 1885, Métis were often considered by the government and the churches to be rebellious or squatters. Many communities were forcibly relocated to Road Allowances in the Prairies.\n\nAround the turn of the 20th century, the federal government created classes of Métis to guide admission. In a letter from school officials, the three 'classes' were described as:\n\n1. Those who live the ordinary settled life.\n2. Those who live the Indian mode of life.\n3. Those who – and they form the most unfortunate class – are the illegitimate offspring of Indian women.",
            "In other words: those who lived like white settlers, those who were considered by the government to live “like Indians,” and those who were considered illegitimate Indigenous children. The last two “classes” were the children most likely to be institutionalized in residential schools.\n\nFor the most part, school officials were concerned with funding. School officials often manipulated the 'classes' of Métis children to benefit the school’s administration. More children in the schools meant they could receive more funding.",
            "(You will begin your day waking up in your family's home on the Road Allowance. You must navigate a typical day at the Île-à-la-Crosse Residential School. Pay close attention to your three vital statistics: Hunger, Warmth, and Spirit. Your choices will determine how these fluctuate. If they drop too low, you will face severe consequences. Survive the day.)"
        ];

        // --- STORY DATA ---
        const storyData = {
            "ready_check": {
                text: "[Name], are you ready to begin your journey?",
                promptLabel: "Are you ready?",
                choices: [
                    { text: "Yes", nextScene: "start" },
                    { text: "No", action: "exitGame" }
                ]
            },
            "start": {
                bg: "images/school.jpg", 
                text: `The morning air is biting cold. You wake up in your family's small home on the Road Allowance. It is technically not your land—government officials call your family "squatters". <br><br>The house is drafty. Your grandmother is already awake, warming a small pot of tea. You know there is a long walk ahead of you. The school is miles away through the bush, and if you are late, the doors might be locked.`,
                promptLabel: "What do you do?",
                choices: [
                    {
                        text: "Leave immediately to avoid being locked out.",
                        nextScene: "the_walk_rushed",
                        effects: { hunger: 10, warmth: 0, spirit: 0 } 
                    },
                    {
                        text: "Stay to eat some bannock, risking lateness.",
                        nextScene: "the_walk_fed",
                        effects: { hunger: -20, warmth: 0, spirit: 5 }
                    },
                    {
                        text: "Speak to your grandmother in Michif before you go.",
                        nextScene: "grandmother_talk",
                        effects: { hunger: 5, warmth: 0, spirit: 15 }
                    }
                ]
            },
            // Placeholders
            "the_walk_rushed": { text: "Placeholder: You rush out into the cold...", choices: []},
            "the_walk_fed": { text: "Placeholder: You eat quickly...", choices: []},
            "grandmother_talk": { text: "Placeholder: You speak in Michif...", choices: []}
        };

        // --- ENGINE FUNCTIONS ---
        function typeWriter(text, elementId, callback) {
            const element = document.getElementById(elementId);
            element.innerHTML = ""; 
            state.isTyping = true;
            document.getElementById('continuePrompt').style.visibility = 'hidden'; 

            let i = 0;
            function type() {
                if (i < text.length) {
                    if (text.charAt(i) === '<') {
                        let tag = '';
                        while (text.charAt(i) !== '>' && i < text.length) {
                            tag += text.charAt(i);
                            i++;
                        }
                        tag += '>';
                        i++;
                        element.innerHTML += tag;
                    } else {
                        element.innerHTML += text.charAt(i);
                        i++;
                    }
                    typeTimeouts.push(setTimeout(type, typeSpeed));
                } else {
                    state.isTyping = false;
                    document.getElementById('continuePrompt').style.visibility = 'visible';
                    if (callback) callback();
                }
            }
            type();
        }

        function clearTypewriter() {
            typeTimeouts.forEach(timeout => clearTimeout(timeout));
            typeTimeouts = [];
            state.isTyping = false;
            document.getElementById('continuePrompt').style.visibility = 'visible';
        }

        function playIntroNext() {
             document.getElementById('choices-overlay').style.display = 'none';

            if (state.isTyping) {
                clearTypewriter();
                document.getElementById('story-text').innerHTML = introSequence[state.introIndex];
                return;
            }

            state.introIndex++;

            if (state.introIndex < introSequence.length) {
                typeWriter(introSequence[state.introIndex], 'story-text');
            } else {
                state.inIntro = false;
                showScene("ready_check");
            }
        }

        function showScene(sceneId) {
            const scene = storyData[sceneId];
            if (!scene) return alert("Error: Scene not found: " + sceneId);

            let processedText = scene.text.replace("[Name]", state.name);

            if (scene.bg) {
                 const bgLayer = document.getElementById('bg-layer');
                 if (!bgLayer.style.backgroundImage.includes(scene.bg)) {
                     bgLayer.style.backgroundImage = `url('${scene.bg}')`;
                 }
            }

            typeWriter(processedText, 'story-text', () => {
                presentChoices(scene);
            });
        }

        function presentChoices(scene) {
            const overlay = document.getElementById('choices-overlay');
            const container = document.getElementById('choices-container');
            const promptLabel = document.getElementById('choice-prompt-text');
            
            container.innerHTML = ''; 
            promptLabel.innerText = scene.promptLabel || "Make a choice";

            scene.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerText = choice.text;
                
                if (choice.action === "exitGame") {
                     btn.onclick = () => window.location.href = 'index.html';
                } else {
                     btn.onclick = () => makeChoice(choice);
                }
                
                container.appendChild(btn);
            });
            
            overlay.style.display = 'flex';
        }

        function makeChoice(choice) {
            document.getElementById('choices-overlay').style.display = 'none'; 

            if (state.inIntro === false && document.getElementById('statsBar').style.display === 'none') {
                 document.getElementById('statsBar').style.display = 'flex';
            }

            if (choice.effects) {
                state.hunger += (choice.effects.hunger || 0);
                state.warmth += (choice.effects.warmth || 0);
                state.spirit += (choice.effects.spirit || 0);
                
                state.hunger = Math.max(0, Math.min(100, state.hunger));
                state.warmth = Math.max(0, Math.min(100, state.warmth));
                state.spirit = Math.max(0, Math.min(100, state.spirit));
                updateStatsUI();
            }

            showScene(choice.nextScene);
        }

        function updateStatsUI() {
            document.getElementById('hunger-stat').innerText = state.hunger + "%";
            document.getElementById('warmth-stat').innerText = state.warmth + "%";
            document.getElementById('spirit-stat').innerText = state.spirit + "%";
        }

        function advanceGlobal(e) {
            if (!state.inIntro) return;
            if (e.target.tagName === 'BUTTON') return; 

            if (e.type === 'click' || (e.type === 'keydown' && e.code === 'Space')) {
                 playIntroNext();
            }
        }

        document.body.addEventListener('click', advanceGlobal);
        document.body.addEventListener('keydown', advanceGlobal);

        // START
        typeWriter(introSequence[0], 'story-text');

    </script>
</body>
</html>
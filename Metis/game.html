<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation</title>
    <style>
        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: #000;
            height: 100vh;
            overflow: hidden;
            font-family: 'Georgia', serif;
            color: white;
        }

        /* --- LAYERS --- */

        /* 1. BACKGROUND */
        #bg-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #222;
            background-image: url('images/school.jpg');
            background-size: cover;
            background-position: center;
            z-index: 1;
            transition: opacity 0.5s ease-in-out;
        }

        /* 2. TOP UI */
        .top-ui-container {
            position: absolute;
            top: 20px; right: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            z-index: 15;
        }

        .stats-bar {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px 25px;
            border-radius: 50px;
            display: flex;
            gap: 20px;
            font-family: sans-serif;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid #555;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .stat-value { font-weight: bold; color: #FFD700; }

        .time-display {
            background: rgba(0, 0, 0, 0.9);
            color: #eee;
            padding: 8px 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            border: 1px solid #777;
        }

        /* UI BUTTONS */
        .ui-btn {
            background: #8B4513;
            color: #fff;
            border: 2px solid #D2691E;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: serif;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            margin-top: 5px;
            text-align: center;
            width: 100%;
        }
        .ui-btn:hover { transform: scale(1.05); background: #A0522D; }
        #audio-btn { background: #333; border-color: #555; }

        /* 3. NOTIFICATIONS */
        #stat-notification {
            position: absolute;
            top: 250px;
            right: 30px;
            text-align: right;
            font-family: sans-serif;
            font-weight: bold;
            font-size: 1rem;
            text-shadow: 1px 1px 3px #000;
            z-index: 15;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* 4. DIALOGUE */
        #dialogue-container {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            height: 100vh;
            z-index: 5;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }

        #character-sprite {
            position: absolute;
            bottom: 0;
            left: 5%;
            height: 85vh;
            width: auto;
            z-index: 5;
            pointer-events: none;
            filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.8));
            opacity: 0.95;
            transition: opacity 0.3s ease-in-out;
        }

        .text-box-bg {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 30vh;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #555;
            border-radius: 10px;
            padding: 25px 35px;
            color: #fff;
            z-index: 10;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            pointer-events: auto;
        }

        #story-text {
            font-size: 1.25rem;
            line-height: 1.6;
            flex-grow: 1;
            white-space: pre-wrap;
            overflow-y: auto;
            padding-right: 15px;
        }
        #story-text::-webkit-scrollbar { width: 10px; }
        #story-text::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 5px; }
        #story-text::-webkit-scrollbar-thumb { background-color: #888; border-radius: 5px; border: 2px solid rgba(0,0,0,0.9); }

        @media (max-height: 800px) {
            #story-text { font-size: 1.1rem; }
            #character-sprite { height: 80vh; }
        }

        .continue-prompt {
            text-align: right;
            font-size: 0.9rem;
            color: #aaa;
            animation: blink 1.5s infinite;
            margin-top: 10px;
            visibility: hidden;
            flex-shrink: 0;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* 5. CHOICES */
        #choices-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92);
            z-index: 20;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }

        .choice-btn {
            background-color: #f0f2f5;
            border: 2px solid #2c3e50;
            color: #2c3e50;
            padding: 20px 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: sans-serif;
            width: 80%;
            max-width: 600px;
            text-align: center;
            border-radius: 8px;
            pointer-events: auto;
        }
        .choice-btn:hover { background-color: #2c3e50; color: white; transform: scale(1.02); border-color: #FFD700; }
        #choice-prompt-text { color: white; margin-bottom: 30px; font-size: 1.5rem; text-align: center; max-width: 80%; }

        /* 6. OVERLAYS (Time Skip / Map / Notebook) */
        #time-skip-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 30;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1.5s ease-in-out;
        }
        #time-skip-text { color: white; font-size: 3rem; font-family: serif; letter-spacing: 2px; }
        .overlay-active { opacity: 1 !important; pointer-events: auto !important; cursor: pointer; }

        #map-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('images/school.jpg');
            background-size: cover;
            background-position: center;
            filter: grayscale(100%) contrast(120%) brightness(40%);
            z-index: 25;
            display: none;
        }
        .map-title { position: absolute; top: 10%; width: 100%; text-align: center; font-size: 2.5rem; color: #eee; text-transform: uppercase; letter-spacing: 5px; text-shadow: 0 0 10px #000; }
        .map-btn {
            position: absolute; background: #222; color: #ddd; border: 2px solid #555; padding: 15px 25px;
            font-family: 'Courier New', monospace; font-weight: bold; text-transform: uppercase; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 0 15px rgba(0,0,0,0.8); width: 220px;
        }
        .map-btn:hover { background: #ddd; color: #111; border-color: #fff; transform: scale(1.1); }
        .map-btn:disabled { opacity: 0.3; cursor: not-allowed; text-decoration: line-through; border-color: #333; }
        #btn-class { top: 30%; left: 20%; }
        #btn-hallway { top: 30%; right: 20%; }
        #btn-work { bottom: 30%; left: 50%; transform: translateX(-50%); }

        #notebook-modal {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 600px; height: 70vh; background-color: #FDF5E6; color: #333;
            border: 10px solid #5D4037; border-radius: 5px; z-index: 50; padding: 40px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow-y: auto; font-family: 'Times New Roman', serif;
        }
        #notebook-modal h2 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        .notebook-entry { margin-bottom: 20px; border-bottom: 1px dashed #ccc; padding-bottom: 15px; }
        .notebook-term { font-weight: bold; font-size: 1.2rem; color: #8B0000; }
        .notebook-def { font-size: 1rem; line-height: 1.5; }
        #close-notebook { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #333; }

    </style>
</head>
<body>

    <audio id="bgm-wind" loop><source src="images/wind.mp3" type="audio/mpeg"></audio>
    <audio id="bgm-hall" loop><source src="images/hallway.mp3" type="audio/mpeg"></audio>
    <audio id="bgm-class" loop><source src="images/class.mp3" type="audio/mpeg"></audio>
    <audio id="sfx-bell"><source src="images/bell.mp3" type="audio/mpeg"></audio>

    <div id="bg-layer"></div>

    <div id="map-layer">
        <h1 class="map-title">Schedule</h1>
        <button class="map-btn" id="btn-class" onclick="triggerMapScene('scene_class_start', 3)">Classroom (3h)</button>
        <button class="map-btn" id="btn-hallway" onclick="triggerMapScene('scene_hallway_start', 1)">Hallway (1h)</button>
        <button class="map-btn" id="btn-work" onclick="triggerMapScene('scene_work', 4)">School Labor (4h)</button>
    </div>

    <div class="top-ui-container" id="statsContainer" style="display:none;">
        <div class="stats-bar">
            <span>Hunger: <span id="hunger-stat" class="stat-value">50%</span></span>
            <span>Warmth: <span id="warmth-stat" class="stat-value">100%</span></span>
            <span>Spirit: <span id="spirit-stat" class="stat-value">100%</span></span>
        </div>
        <div class="time-display" id="timeDisplay">8:00 AM</div>
        <button class="ui-btn" id="notebook-btn" onclick="toggleNotebook()">ðŸ“– Historical Notebook</button>
        <button class="ui-btn" id="audio-btn" onclick="toggleMute()">ðŸ”Š Audio: ON</button>
    </div>
   
    <div id="stat-notification"></div>

    <div id="notebook-modal">
        <button id="close-notebook" onclick="toggleNotebook()">Ã—</button>
        <h2>Historical Terms</h2>
        <div id="notebook-content">
            <p style="text-align:center; font-style:italic;">No entries yet. Play the game to unlock definitions.</p>
        </div>
    </div>

    <div id="dialogue-container">
        <img id="character-sprite" src="" alt="Character">
        <div class="text-box-bg">
            <div id="story-text">Loading...</div>
            <div id="continuePrompt" class="continue-prompt">Click or Press Space to continue â–¼</div>
        </div>
    </div>

    <div id="choices-overlay">
        <h2 id="choice-prompt-text">Make a choice</h2>
        <div id="choices-container" style="display:flex; flex-direction:column; gap:20px; width: 100%; align-items: center;">
        </div>
    </div>

    <div id="time-skip-overlay">
        <div id="time-skip-text">30 minutes pass</div>
    </div>


    <script>
        // --- ERROR TRAP ---
        window.onerror = function(message, source, lineno, colno, error) {
            alert("GAME ERROR:\n" + message + "\nLine: " + lineno);
        };

        // --- GAME STATE ---
        let state = {
            hunger: 50, // 0 = Full, 100 = Starving
            warmth: 100, // 100 = Warm, 0 = Freezing
            spirit: 100, // 100 = Happy, 0 = Broken
            time: 8,
            name: localStorage.getItem('playerName') || "Student",
            gender: localStorage.getItem('playerGender') || "other",
            introIndex: 0,
            isTyping: false,
            inIntro: true,
            currentScene: null,    
            waitingForInput: false,
            inTimeSkip: false,
            visitedScenes: [],
            mapActive: false,
            lunchEaten: false,
            unlockedTerms: [],
            isMuted: false,
            currentTrack: null
        };

        const typeSpeed = 25;
        let typeTimeouts = [];

        // --- ASSETS ---
        const charImgElement = document.getElementById('character-sprite');
        let playerImage = 'images/boy.png';
        if (state.gender === 'female') playerImage = 'images/girl.png';
        charImgElement.src = playerImage;

        // --- INTRO (REVISED) ---
        const introSequence = [
            "The year is 1970. You are a MÃ©tis child attending ÃŽle-Ã -la-Crosse Residential School. Both of your parents are MÃ©tis, descendants of the buffalo hunters and the Red River resistance. You are not 'half' of anything; you are fully Indigenous, belonging to a distinct Nation with its own culture and language.",
            
            "HISTORICAL NOTE: In this simulation, you will encounter the term 'half-breed.' This is a derogatory legal and social label historically used by the government and church to marginalize MÃ©tis people. It falsely implies that MÃ©tis are simply 'mixed-blood' individuals without a distinct identity. In reality, the MÃ©tis are a distinct Indigenous people, separate from First Nations and Inuit.",
            
            "Following the resistances of 1869 and 1885, MÃ©tis were often considered by the government and the churches to be rebellious or squatters. Many communities were forcibly relocated to Road Allowances in the Prairies.",
            
            "Around the turn of the 20th century, the federal government created classes of MÃ©tis to guide admission. The 'classes' were used to deny responsibility for MÃ©tis education, often leaving children in jurisdictional limbo.",
            
            "(You will begin your day waking up in your family's home on the Road Allowance. You must navigate a typical day at the ÃŽle-Ã -la-Crosse Residential School. Pay close attention to your three vital statistics: Hunger, Warmth, and Spirit. If they drop too low, you will face severe consequences.)"
        ];

        // --- NOTEBOOK DATA ---
        const notebookDB = {
            "road_allowance": { term: "Road Allowance", def: "Strips of Crown land reserved for potential road construction. Many MÃ©tis families built shacks here as they had nowhere else to live." },
            "squatter": { term: "Squatters", def: "A derogatory term used by the government to describe MÃ©tis families living on Crown land to justify denying them services." },
            "extern": { term: "Extern / Day Scholar", def: "Students who attended residential schools during the day but went home at night. Often treated as 'lesser' than boarders." },
            "michif": { term: "Michif", def: "The language of the MÃ©tis people, blending Cree verbs with French nouns. Schools actively suppressed this language." },
            "lateral_violence": { term: "Lateral Violence", def: "When oppressed groups direct anger toward each other. In schools, this manifested as conflict between First Nations and MÃ©tis students." }
        };

        // --- STORY DATA ---
        const storyData = {
            "ready_check": {
                text: "[Name], are you ready to begin your journey?",
                promptLabel: "Are you ready?",
                choices: [
                    { text: "Yes (Start Audio)", nextScene: "start_part1", action: "startAudio" },
                    { text: "No", action: "exitGame" }
                ]
            },
           
            // START
            "start_part1": {
                bg: "images/road.JPG",
                audio: "bgm-wind",
                text: `The morning air is biting cold. You wake up in your family's small home on the Road Allowance. It is technically not your landâ€”government officials call your family "squatters".`,
                nextScene: "start_part2",
                unlocks: ["road_allowance", "squatter"]
            },
            "start_part2": {
                bg: "images/road.JPG",
                audio: "bgm-wind",
                text: `The house is drafty. Your grandmother is already awake, warming a small pot of tea. You know there is a long walk ahead of you. The school is miles away through the bush, and if you are late, the doors might be locked.`,
                promptLabel: "What do you do?",
                choices: [
                    { text: "Leave immediately.", nextScene: "walk_intro", effects: { hunger: 10, warmth: 0, spirit: 0 } },
                    { text: "Stay to eat bannock.", nextScene: "walk_intro", effects: { hunger: -30, warmth: 0, spirit: 5 } },
                    { text: "Speak Michif.", nextScene: "walk_intro", effects: { hunger: 5, warmth: 0, spirit: 15 } }
                ]
            },

            // WALK
            "walk_intro": {
                bg: "images/road.JPG",
                audio: "bgm-wind",
                text: `I looked back at the shack one last time. It sits on that thirty-foot strip of dirt the government calls a road allowance, the only place they let us be.`,
                nextScene: "walk_cold"
            },
            "walk_cold": {
                bg: "images/road.JPG",
                audio: "bgm-wind",
                text: `Three miles. It feels longer when the wind cuts right through this coat. Iâ€™m an "extern," thatâ€™s what they call us. Not a boarder, not fully part of the school, just someone walking in from the bush.`,
                nextScene: "walk_identity",
                unlocks: ["extern"]
            },
            "walk_identity": {
                bg: "images/road.JPG",
                audio: "bgm-wind",
                text: `I listened to Dad argue with the Indian Agent. Itâ€™s always the same. We are too "white" for the Treaty benefits, but too "Indian" for the town schools.`,
                nextScene: "arrival_scene"
            },

            // ARRIVAL
            "arrival_scene": {
                bg: "images/school2.jpg",
                audio: "bgm-wind",
                effects: { spirit: -25, hunger: 15, warmth: -50 },
                text: `I finally arrive at the school. Part of me wishes I stayed back at home helping father chop firewood. He's getting sicker by the day.`,
                nextScene: "arrival_waiting"
            },
            "arrival_waiting": {
                bg: "images/school2.jpg",
                audio: "bgm-wind",
                text: `The Sisters of Charity say we clutter the halls if we come in before morning prayer. I must wait in the snow.`,
                specialAction: "triggerTimeSkip"
            },
            "school_entry": {
                bg: "images/school2.jpg",
                characterImg: "images/nun.png",
                audio: "bgm-hall",
                text: "Finally, the bell rings and the heavy doors clank open. A Sister of Charity stands in the doorway, blocking the warmth from escaping.",
                nextScene: "nun_dialogue_1",
                sfx: "sfx-bell"
            },
            "nun_dialogue_1": {
                bg: "images/school2.jpg",
                characterImg: "images/nun.png",
                audio: "bgm-hall",
                text: `Finally. Get in, get in. Don't drag that snow onto the floor. You half-breeds are always lurking about. Wipe your feet. You're lucky we let you in at all.`,
                nextScene: "nun_dialogue_2"
            },
            "nun_dialogue_2": {
                bg: "images/school2.jpg",
                characterImg: "images/nun.png",
                audio: "bgm-hall",
                text: `The government doesn't pay a cent for you to be here, you know. You are here out of charity, so try to look less like a savage and more like a student.`,
                specialAction: "triggerMap"
            },

            // --- CLASSROOM (INTERACTIVE) ---
            "scene_class_start": {
                bg: "images/class.jpg",
                characterImg: null,
                audio: "bgm-class",
                text: `The room is austere. A crucifix hangs prominently on the wall.`,
                nextScene: "scene_class_language"
            },
            "scene_class_language": {
                bg: "images/class.jpg",
                characterImg: "images/nun.png",
                audio: "bgm-class",
                text: `I heard speaking in the hallway earlier. I heard that... dialect. You know the rules. English is the language of this school. If I hear that 'Michif' or Cree gibberish again, you will be punished.`,
                nextScene: "scene_class_yvonne",
                unlocks: ["michif"]
            },
            "scene_class_yvonne": {
                bg: "images/class.jpg",
                characterImg: "images/nun.png",
                audio: "bgm-class",
                text: `Let's hope we do not have another Yvonne incident... *she points to her ruler* young lady do you want to tell the new students what happened when you used your forbidden nonsense?`,
                nextScene: "scene_class_posture"
            },
            "scene_class_posture": {
                bg: "images/class.jpg",
                characterImg: "images/nun.png",
                audio: "bgm-class",
                text: `That's what I thought. Open your books. We are studying the settlement of the West. You must understand that before the government and the Church arrived, there was no order here. It is only through the grace of God that you are receiving an education.`,
                promptLabel: "How do you react?",
                choices: [
                    {
                        text: "Stay silent and keep your head down.",
                        nextScene: "scene_class_end",
                        effects: { spirit: -5, hunger: 5, warmth: 20 } // Safe but sad
                    },
                    {
                        text: "Whisper in Michif under your breath.",
                        nextScene: "scene_class_punished",
                        effects: { spirit: 5, hunger: 5, warmth: 20 } // Defiant
                    }
                ]
            },
            "scene_class_punished": {
                bg: "images/class.jpg",
                characterImg: "images/nun.png",
                audio: "bgm-class",
                text: `The nun's ears are sharp. "I heard that!" she snaps. She forces you to stand in the corner facing the wall for the rest of the lesson. Your legs ache, but your spirit remains unbroken.`,
                effects: { spirit: -5 }, // Penalty for getting caught
                specialAction: "returnToMap"
            },
            "scene_class_end": {
                bg: "images/class.jpg",
                characterImg: "images/nun.png",
                text: `You endure the lesson in silence. The warmth of the room is the only comfort, though the words spoken here are cold.`,
                specialAction: "returnToMap"
            },

            // --- HALLWAY (INTERACTIVE) ---
            "scene_hallway_start": {
                bg: "images/hallway.jpg",
                characterImg: null,
                audio: "bgm-hall",
                text: `The hallway smells of floor wax and old cabbage. You try to move quickly to your next task.`,
                specialAction: "checkGenderHallway",
                unlocks: ["lateral_violence"]
            },
            "scene_hallway_girl_1": {
                bg: "images/hallway.jpg",
                characterImg: null,
                audio: "bgm-hall",
                text: `Cree Student (Girl): (She steps out, blocking your path.)\n\n"Where do you think you are going, Monias? You aren't white enough for them, and you certainly aren't one of us."`,
                nextScene: "scene_hallway_girl_2"
            },
            "scene_hallway_girl_2": {
                bg: "images/hallway.jpg",
                characterImg: null,
                audio: "bgm-hall",
                text: `(She shoves your shoulder.)\n\n"You don't belong here. This place is for Indians. You don't have a Treaty number. You are just a 'half-breed' charity case taking our food."`,
                nextScene: "scene_hallway_girl_3"
            },
            "scene_hallway_girl_3": {
                bg: "images/hallway.jpg",
                characterImg: null,
                text: `(She leans in, lowering her voice to a cruel whisper.)\n\n"My mother told me about people like you. 'Les Petites Sauvages,' the white townspeople call you. But in here? You are just a 'bannock-eater'. You act like you are special because maybe you speak French, or maybe you have some fancy beads sewn poorly on your scarf, but you are just an illegitimate mistake. Go cry to the nuns. They are the only ones who want you here."`,
                effects: { spirit: -20, warmth: -5 },
                specialAction: "returnToMap"
            },
            "scene_hallway_boy_1": {
                bg: "images/hallway.jpg",
                characterImg: null,
                audio: "bgm-hall",
                text: `Cree Student (Boy): (He slams you against the wall.)\n\n"What are you looking at, Monias? You are a traitor. Your grandfathers helped the white man take our land."`,
                nextScene: "scene_hallway_boy_2"
            },
            "scene_hallway_boy_2": {
                bg: "images/hallway.jpg",
                characterImg: null,
                audio: "bgm-hall",
                text: `"This school is for Real Indians. Not road allowance trash."\n\n(They kick at your shins. It hurts, but you don't cry out.)`,
                nextScene: "scene_hallway_boy_3"
            },
            "scene_hallway_boy_3": {
                bg: "images/hallway.jpg",
                characterImg: null,
                text: `"You don't have a band. You don't have a chief. You are nobody's child. If you tell the Supervisor, we will tell them you started it. And who will they believe? The savage, or the half-breed who doesn't know his place? Stay away from us. Next time, we won't stop with just a few kicks."`,
                effects: { spirit: -20, hunger: 5 },
                specialAction: "returnToMap"
            },

            // --- LUNCH (INTERACTIVE) ---
            "scene_lunch": {
                bg: "images/school2.jpg",
                characterImg: null,
                audio: "bgm-hall",
                text: `The bell rings for noon. The "Boarders" line up for the dining hall. As an "Extern," you are stopped at the dining hall door. "Day scholars outside," the supervisor barks.\n\nYou sit on the cold steps. Your bannock from home is frozen solid.`,
                promptLabel: "What do you do?",
                choices: [
                    {
                        text: "Eat the frozen bannock.",
                        nextScene: "scene_lunch_eat",
                        effects: { hunger: -15, warmth: -10 } // Reduces hunger, but makes you colder
                    },
                    {
                        text: "Skip lunch to stay warm inside your coat.",
                        nextScene: "scene_lunch_skip",
                        effects: { hunger: 10, spirit: 5 } // Hungrier, but defiant
                    }
                ]
            },
            "scene_lunch_eat": {
                bg: "images/school2.jpg",
                text: `You chip away at the frozen bread. It sits heavy and cold in your stomach, but the gnawing hunger fades slightly.`,
                specialAction: "returnToMap"
            },
            "scene_lunch_skip": {
                bg: "images/school2.jpg",
                text: `You refuse to eat the frozen food like an animal. You wrap your coat tighter and wait for the bell, hungry but proud.`,
                specialAction: "returnToMap"
            },

            // --- WORK ---
            "scene_work": {
                bg: "images/school2.jpg",
                characterImg: "images/nun.png",
                audio: "bgm-class",
                text: "[DYNAMIC_TEXT]",
                effects: { hunger: 20, spirit: -15, warmth: 0 },
                nextScene: "end_of_day"
            },
            "end_of_day": {
                bg: "images/road.JPG",
                characterImg: null,
                audio: "bgm-wind",
                text: `The final bell rings. The day is over. While the Boarders retreat to their dorms, you are pushed back out into the cold evening air.\n\nYou survived another day. But you have to do it all again tomorrow.`,
                promptLabel: "End of Demo",
                choices: [
                    { text: "Restart Simulation", action: "exitGame" }
                ]
            },

            // --- GAME OVER SCENES ---
            "game_over_cold": {
                bg: "images/road.JPG",
                text: `GAME OVER: Hypothermia.\n\nThe cold was too much. You collapsed on the road allowance before reaching safety. In this system, warmth is a luxury you could not afford.`,
                promptLabel: "Try Again",
                choices: [{ text: "Restart", action: "exitGame" }]
            },
            "game_over_starve": {
                bg: "images/school2.jpg",
                text: `GAME OVER: Malnutrition.\n\nThe lack of food has taken its toll. You fainted during chores and were taken to the Indian Hospital. You may never return home.`,
                promptLabel: "Try Again",
                choices: [{ text: "Restart", action: "exitGame" }]
            },
            "game_over_spirit": {
                bg: "images/road.JPG",
                text: `GAME OVER: Broken Spirit.\n\nThe constant abuse and isolation broke your will. You ran away into the bush, preferring the risk of the wild to the cruelty of the school.`,
                promptLabel: "Try Again",
                choices: [{ text: "Restart", action: "exitGame" }]
            }
        };

        // --- FUNCTIONS ---

        function checkStats() {
            if (state.warmth <= 0) showScene("game_over_cold");
            else if (state.hunger >= 100) showScene("game_over_starve");
            else if (state.spirit <= 0) showScene("game_over_spirit");
        }

        function typeWriter(text, elementId, callback) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.innerHTML = "";
            state.isTyping = true;
            document.getElementById('continuePrompt').style.visibility = 'hidden';

            let i = 0;
            function type() {
                if (i < text.length) {
                    if (text.charAt(i) === '<') {
                        let tag = '';
                        while (text.charAt(i) !== '>' && i < text.length) { tag += text.charAt(i); i++; }
                        tag += '>'; i++;
                        element.innerHTML += tag;
                    } else {
                        element.innerHTML += text.charAt(i); i++;
                    }
                    typeTimeouts.push(setTimeout(type, typeSpeed));
                } else {
                    state.isTyping = false;
                    document.getElementById('continuePrompt').style.visibility = 'visible';
                    if (callback) callback();
                }
            }
            type();
        }

        function clearTypewriter() {
            typeTimeouts.forEach(timeout => clearTimeout(timeout));
            typeTimeouts = [];
            state.isTyping = false;
            document.getElementById('continuePrompt').style.visibility = 'visible';
        }

        function playIntroNext() {
             document.getElementById('choices-overlay').style.display = 'none';
            if (state.isTyping) {
                clearTypewriter();
                document.getElementById('story-text').innerHTML = introSequence[state.introIndex];
                return;
            }
            state.introIndex++;
            if (state.introIndex < introSequence.length) {
                typeWriter(introSequence[state.introIndex], 'story-text');
            } else {
                state.inIntro = false;
                showScene("ready_check");
            }
        }

        function showScene(sceneId) {
            if (sceneId === "checkGenderHallway") {
                if (state.gender === 'female') showScene("scene_hallway_girl_1");
                else showScene("scene_hallway_boy_1");
                return;
            }

            const scene = storyData[sceneId];
            if (!scene) return alert("Error: Scene not found: " + sceneId);

            state.currentScene = scene;
            state.waitingForInput = false;

            // Dynamic Text
            if (sceneId === "scene_work") {
                if (state.gender === 'female') {
                    scene.text = "It is time for the 'Half-Day' work. For girls, this means cooking, cleaning, laundry, and sewing. You scrub the floors until your knees are raw, unpaid and unthanked.";
                } else {
                    scene.text = "It is time for the 'Half-Day' work. For boys, this means farming, wood-chopping, and stock raising. You haul heavy logs in the cold until your muscles burn, unpaid and unthanked.";
                }
            }

            if (scene.unlocks) scene.unlocks.forEach(termId => unlockTerm(termId));
            if (scene.audio) playAudio(scene.audio);
            if (scene.sfx) playSFX(scene.sfx);

            // Images
            const charImg = document.getElementById('character-sprite');
            if (scene.characterImg === null) {
                 charImg.style.opacity = 0;
            } else if (scene.characterImg) {
                if (!charImg.src.includes(scene.characterImg)) {
                     charImg.style.opacity = 0;
                     setTimeout(() => { charImg.src = scene.characterImg; charImg.style.opacity = 0.95; }, 200);
                } else { charImg.style.opacity = 0.95; }
            } else {
                let playerDefault = (state.gender === 'female') ? 'images/girl.png' : 'images/boy.png';
                if (!charImg.src.includes(playerDefault)) {
                    charImg.style.opacity = 0;
                    setTimeout(() => { charImg.src = playerDefault; charImg.style.opacity = 0.95; }, 200);
                } else { charImg.style.opacity = 0.95; }
            }

            // Stats
            if (scene.effects) applyStats(scene.effects);

            let processedText = scene.text.replace("[Name]", state.name);
            if (scene.bg) {
                 document.getElementById('bg-layer').style.backgroundImage = `url('${scene.bg}')`;
            }

            typeWriter(processedText, 'story-text', () => {
                state.waitingForInput = true;
                checkStats(); // Check for Game Over after text
            });
        }

        function presentChoices(scene) {
            const overlay = document.getElementById('choices-overlay');
            const container = document.getElementById('choices-container');
            const promptLabel = document.getElementById('choice-prompt-text');
           
            container.innerHTML = '';
            promptLabel.innerText = scene.promptLabel || "Make a choice";

            scene.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerText = choice.text;
                if (choice.action === "exitGame") {
                    btn.onclick = () => window.location.href = 'index.html';
                }
                else if (choice.action === "startAudio") {
                    btn.onclick = () => { playAudio("bgm-wind"); makeChoice(choice); };
                }
                else {
                    btn.onclick = () => makeChoice(choice);
                }
                container.appendChild(btn);
            });
            overlay.style.display = 'flex';
        }

        function showNotification(changes) {
            let messages = [];
            if (changes && changes.hunger) {
                if (changes.hunger > 0) messages.push(`<span style="color:#ff6b6b">Hunger +${changes.hunger}%</span>`);
                else messages.push(`<span style="color:#51cf66">Hunger -${Math.abs(changes.hunger)}%</span>`);
            }
            if (changes && changes.warmth) {
                if (changes.warmth < 0) messages.push(`<span style="color:#ff6b6b">Warmth -${Math.abs(changes.warmth)}%</span>`);
                else messages.push(`<span style="color:#51cf66">Warmth +${changes.warmth}%</span>`);
            }
            if (changes && changes.spirit) {
                 if (changes.spirit < 0) messages.push(`<span style="color:#ff6b6b">Spirit -${Math.abs(changes.spirit)}%</span>`);
                 else messages.push(`<span style="color:#51cf66">Spirit +${changes.spirit}%</span>`);
            }
            if (typeof changes === "string") messages.push(`<span style="color:#FFD700">ðŸ“– ${changes}</span>`);

            if (messages.length > 0) {
                const note = document.getElementById('stat-notification');
                note.innerHTML = messages.join("<br>");
                note.style.opacity = 1;
                setTimeout(() => { note.style.opacity = 0; }, 3000);
            }
        }

        function applyStats(effects) {
            showNotification(effects);
            state.hunger += (effects.hunger || 0);
            state.warmth += (effects.warmth || 0);
            state.spirit += (effects.spirit || 0);
            state.hunger = Math.max(0, Math.min(100, state.hunger));
            state.warmth = Math.max(0, Math.min(100, state.warmth));
            state.spirit = Math.max(0, Math.min(100, state.spirit));
            updateStatsUI();
        }

        function makeChoice(choice) {
            document.getElementById('choices-overlay').style.display = 'none';
            if (state.inIntro === false && document.getElementById('statsContainer').style.display === 'none') {
                 document.getElementById('statsContainer').style.display = 'flex';
            }
            if (choice.effects) applyStats(choice.effects);
            showScene(choice.nextScene);
        }

        function toggleNotebook() {
            const modal = document.getElementById('notebook-modal');
            if (modal.style.display === 'block') { modal.style.display = 'none'; }
            else { renderNotebook(); modal.style.display = 'block'; }
        }

        function unlockTerm(termId) {
            if (!state.unlockedTerms.includes(termId)) {
                state.unlockedTerms.push(termId);
                const termName = notebookDB[termId].term;
                showNotification("Notebook Updated: " + termName);
            }
        }

        function renderNotebook() {
            const contentDiv = document.getElementById('notebook-content');
            contentDiv.innerHTML = "";
            if (state.unlockedTerms.length === 0) {
                contentDiv.innerHTML = '<p style="text-align:center; font-style:italic;">No entries yet.</p>';
                return;
            }
            state.unlockedTerms.forEach(termId => {
                const entry = notebookDB[termId];
                const div = document.createElement('div');
                div.className = 'notebook-entry';
                div.innerHTML = `<div class="notebook-term">${entry.term}</div><div class="notebook-def">${entry.def}</div>`;
                contentDiv.appendChild(div);
            });
        }

        function toggleMute() {
            state.isMuted = !state.isMuted;
            document.querySelectorAll('audio').forEach(a => a.muted = state.isMuted);
            document.getElementById('audio-btn').innerText = state.isMuted ? "ðŸ”Š Audio: OFF" : "ðŸ”Š Audio: ON";
        }

        function playAudio(trackId) {
            if (!trackId || state.currentTrack === trackId) return;
            document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime = 0; });
            const newTrack = document.getElementById(trackId);
            if (newTrack) {
                newTrack.volume = 0.5;
                newTrack.play().catch(e => console.log("Audio waiting"));
                state.currentTrack = trackId;
            }
        }

        function playSFX(sfxId) {
            if (state.isMuted) return;
            const sound = document.getElementById(sfxId);
            if (sound) { sound.currentTime = 0; sound.play(); }
        }

        function updateTimeDisplay() {
            let suffix = state.time >= 12 ? "PM" : "AM";
            let displayHour = state.time > 12 ? state.time - 12 : state.time;
            document.getElementById('timeDisplay').innerText = `${displayHour}:00 ${suffix}`;
        }

        function showMap() {
            state.mapActive = true;
            document.getElementById('dialogue-container').style.opacity = 0;
            document.getElementById('map-layer').style.display = 'block';

            const btnClass = document.getElementById('btn-class');
            const btnHall = document.getElementById('btn-hallway');
            const btnWork = document.getElementById('btn-work');

            btnClass.disabled = true;
            btnHall.disabled = true;
            btnWork.disabled = true;

            if (state.time < 12) {
                if (state.time <= 9 && !state.visitedScenes.includes('scene_class_start')) btnClass.disabled = false;
                if (state.time < 12 && !state.visitedScenes.includes('scene_hallway_start')) btnHall.disabled = false;
            }
            else if (state.lunchEaten) {
                btnWork.disabled = false;
            }
        }

        function hideMap() {
            state.mapActive = false;
            document.getElementById('map-layer').style.display = 'none';
            document.getElementById('dialogue-container').style.opacity = 1;
        }

        function triggerMapScene(sceneId, duration) {
            hideMap();
            if (!state.visitedScenes.includes(sceneId)) state.visitedScenes.push(sceneId);
            if (duration) { state.time += duration; updateTimeDisplay(); }
            showScene(sceneId);
        }

        function returnToMapLogic() {
            if (state.time >= 12 && !state.lunchEaten) {
                state.lunchEaten = true;
                state.time += 1;
                updateTimeDisplay();
                showScene('scene_lunch');
            } else {
                showMap();
            }
        }

        function triggerTimeSkip() {
            state.inTimeSkip = true;
            state.waitingForInput = false;
            document.getElementById('dialogue-container').style.opacity = 0;
            document.getElementById('statsContainer').style.display = 'none';
            const overlay = document.getElementById('time-skip-overlay');
            overlay.classList.add('overlay-active');
            setTimeout(() => { applyStats({ hunger: 10, spirit: -10, warmth: -15 }); }, 1000);
            overlay.onclick = function() {
                overlay.classList.remove('overlay-active');
                document.getElementById('dialogue-container').style.opacity = 1;
                document.getElementById('statsContainer').style.display = 'flex';
                setTimeout(() => { state.inTimeSkip = false; showScene("school_entry"); }, 1500);
                overlay.onclick = null;
            };
        }

        function updateStatsUI() {
            document.getElementById('hunger-stat').innerText = state.hunger + "%";
            document.getElementById('warmth-stat').innerText = state.warmth + "%";
            document.getElementById('spirit-stat').innerText = state.spirit + "%";
        }

        function advanceGlobal(e) {
            if (e.target.tagName === 'BUTTON') return;
            if (state.inTimeSkip || state.mapActive) return;
            if (state.inIntro) { playIntroNext(); return; }

            if (state.isTyping) {
                clearTypewriter();
                state.waitingForInput = true;
                let txt = state.currentScene.text.replace("[Name]", state.name);
                document.getElementById('story-text').innerHTML = txt;
                return;
            }

            if (state.waitingForInput) {
                if (state.currentScene.specialAction === "triggerTimeSkip") triggerTimeSkip();
                else if (state.currentScene.specialAction === "triggerMap") showMap();
                else if (state.currentScene.specialAction === "returnToMap") returnToMapLogic();
                else if (state.currentScene.specialAction === "checkGenderHallway") showScene("checkGenderHallway");
                else if (state.currentScene.choices) { presentChoices(state.currentScene); state.waitingForInput = false; }
                else if (state.currentScene.nextScene) showScene(state.currentScene.nextScene);
            }
        }

        document.body.addEventListener('click', advanceGlobal);
        document.body.addEventListener('keydown', (e) => { if (e.code === 'Space') advanceGlobal(e); });
        typeWriter(introSequence[0], 'story-text');

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation</title>
    <style>
        /* RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: #000;
            height: 100vh;
            overflow: hidden; /* Prevent scrolling */
            font-family: 'Georgia', serif;
            color: white;
        }

        /* --- LAYERS --- */

        /* LAYER 1: BACKGROUND */
        #bg-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #111; 
            background-image: url('images/school.jpg'); 
            background-size: cover;
            background-position: center;
            z-index: 1;
            transition: opacity 1s ease-in-out;
        }

        /* LAYER 2: STATS BAR */
        .stats-bar {
            position: absolute;
            top: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 15px 30px;
            border-radius: 50px;
            display: flex;
            gap: 30px; 
            z-index: 10;
            font-family: sans-serif;
            font-size: 1.1rem; 
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid #555;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .stat-value { font-weight: bold; color: #FFD700; }

        /* STAT NOTIFICATION */
        #stat-notification {
            position: absolute;
            top: 85px; 
            right: 40px;
            text-align: right;
            font-family: sans-serif;
            font-weight: bold;
            font-size: 1rem;
            text-shadow: 1px 1px 3px #000;
            z-index: 15;
            opacity: 0; 
            transition: opacity 0.5s ease-in-out;
        }

        /* LAYER 3: DIALOGUE BOX CONTAINER */
        #dialogue-container {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            height: 100vh; 
            z-index: 5;
            pointer-events: none; 
            transition: opacity 0.5s ease-in-out;
        }

        /* LAYER 4: CHARACTER SPRITE */
        #character-sprite {
            position: absolute;
            bottom: 0; 
            left: 5%; 
            height: 85vh; 
            width: auto;
            z-index: 5; 
            pointer-events: none;
            filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.8));
            opacity: 0.95;
            transition: opacity 0.3s ease-in-out; /* Smooth swap transition */
        }

        /* LAYER 5: TEXT BOX */
        .text-box-bg {
            position: absolute;
            bottom: 30px; 
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 30vh; 
            background: rgba(0, 0, 0, 0.9); 
            border: 2px solid #555;
            border-radius: 10px;
            padding: 25px 35px; 
            color: #fff;
            z-index: 10; 
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            pointer-events: auto; 
        }

        /* NARRATIVE TEXT */
        #story-text {
            font-size: 1.25rem;
            line-height: 1.6;
            flex-grow: 1;
            white-space: pre-wrap;
            overflow-y: auto; 
            padding-right: 15px; 
            -webkit-overflow-scrolling: touch; 
        }

        /* Scrollbar Styling */
        #story-text::-webkit-scrollbar { width: 10px; }
        #story-text::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 5px; }
        #story-text::-webkit-scrollbar-thumb { background-color: #888; border-radius: 5px; border: 2px solid rgba(0,0,0,0.9); }

        /* RESPONSIVE */
        @media (max-height: 800px) {
            #story-text { font-size: 1.1rem; }
            #character-sprite { height: 80vh; }
        }

        .continue-prompt {
            text-align: right;
            font-size: 0.9rem;
            color: #aaa;
            animation: blink 1.5s infinite;
            margin-top: 10px;
            visibility: hidden; 
            flex-shrink: 0; 
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* CHOICES AREA */
        #choices-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); 
            z-index: 20; 
            display: none; 
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }

        .choice-btn {
            background-color: #f0f2f5;
            border: 2px solid #2c3e50;
            color: #2c3e50;
            padding: 20px 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: sans-serif;
            width: 80%;
            max-width: 600px;
            text-align: center;
            border-radius: 8px;
            pointer-events: auto; 
        }

        .choice-btn:hover {
            background-color: #2c3e50;
            color: white;
            transform: scale(1.02);
            border-color: #FFD700;
        }

        #choice-prompt-text {
            color: white; 
            margin-bottom: 30px; 
            font-size: 1.5rem;
            text-align: center;
            max-width: 80%;
        }

        /* TIME SKIP OVERLAY */
        #time-skip-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 30; 
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0; 
            pointer-events: none;
            transition: opacity 1.5s ease-in-out;
        }

        #time-skip-text {
            color: white;
            font-size: 3rem;
            font-family: serif;
            letter-spacing: 2px;
        }
        
        .overlay-active {
            opacity: 1 !important;
            pointer-events: auto !important;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div id="bg-layer"></div>

    <div class="stats-bar" id="statsBar" style="display:none;">
        <span>Hunger: <span id="hunger-stat" class="stat-value">50%</span></span>
        <span>Warmth: <span id="warmth-stat" class="stat-value">100%</span></span>
        <span>Spirit: <span id="spirit-stat" class="stat-value">100%</span></span>
    </div>
    
    <div id="stat-notification"></div>

    <div id="dialogue-container">
        <img id="character-sprite" src="" alt="Character">
        <div class="text-box-bg">
            <div id="story-text"></div>
            <div id="continuePrompt" class="continue-prompt">Click or Press Space to continue ▼</div>
        </div>
    </div>

    <div id="choices-overlay">
        <h2 id="choice-prompt-text">Make a choice</h2>
        <div id="choices-container" style="display:flex; flex-direction:column; gap:20px; width: 100%; align-items: center;">
        </div>
    </div>

    <div id="time-skip-overlay">
        <div id="time-skip-text">30 minutes pass</div>
    </div>


    <script>
        // --- DIAGNOSTIC TOOL ---
        function checkImage(id, filename) {
            const img = document.getElementById(id);
            img.onerror = function() {
                console.warn("SYSTEM WARNING: Cannot find '" + filename + "'");
            };
        }

        // --- GAME STATE ---
        let state = {
            hunger: 50, 
            warmth: 100,
            spirit: 100,
            name: localStorage.getItem('playerName') || "Student",
            gender: localStorage.getItem('playerGender') || "other",
            introIndex: 0, 
            isTyping: false, 
            inIntro: true,
            currentScene: null,    
            waitingForInput: false,
            inTimeSkip: false 
        };

        const typeSpeed = 25; 
        let typeTimeouts = []; 

        // --- ASSET SETUP ---
        const charImgElement = document.getElementById('character-sprite');
        let playerImage = 'images/boy.png'; // Default

        if (state.gender === 'female') {
            playerImage = 'images/girl.png';
        }
        
        // Initialize with player image
        charImgElement.src = playerImage;
        checkImage('character-sprite', playerImage);

        // --- INTRO SEQUENCE ---
        const introSequence = [
            "The year is 1970 and you, as an Indigenous person belonging to the Métis tribe, are attending Île-à-la-Crosse Residential School.",
            "Following the resistances of 1869 and 1885, Métis were often considered by the government and the churches to be rebellious or squatters. Many communities were forcibly relocated to Road Allowances in the Prairies.\n\nAround the turn of the 20th century, the federal government created classes of Métis to guide admission. In a letter from school officials, the three 'classes' were described as:\n\n1. Those who live the ordinary settled life.\n2. Those who live the Indian mode of life.\n3. Those who – and they form the most unfortunate class – are the illegitimate offspring of Indian women.",
            "In other words: those who lived like white settlers, those who were considered by the government to live “like Indians,” and those who were considered illegitimate Indigenous children. The last two “classes” were the children most likely to be institutionalized in residential schools.\n\nFor the most part, school officials were concerned with funding. School officials often manipulated the 'classes' of Métis children to benefit the school’s administration. More children in the schools meant they could receive more funding.",
            "(You will begin your day waking up in your family's home on the Road Allowance. You must navigate a typical day at the Île-à-la-Crosse Residential School. Pay close attention to your three vital statistics: Hunger, Warmth, and Spirit. Your choices will determine how these fluctuate. If they drop too low, you will face severe consequences. Survive the day.)"
        ];

        // --- STORY DATA ---
        const storyData = {
            "ready_check": {
                text: "[Name], are you ready to begin your journey?",
                promptLabel: "Are you ready?",
                choices: [
                    { text: "Yes", nextScene: "start_part1" }, 
                    { text: "No", action: "exitGame" }
                ]
            },

            // SCENE 1
            "start_part1": {
                bg: "images/road.JPG", 
                text: `The morning air is biting cold. You wake up in your family's small home on the Road Allowance. It is technically not your land—government officials call your family "squatters".`,
                nextScene: "start_part2" 
            },

            "start_part2": {
                bg: "images/road.JPG", 
                text: `The house is drafty. Your grandmother is already awake, warming a small pot of tea. You know there is a long walk ahead of you. The school is miles away through the bush, and if you are late, the doors might be locked.`,
                promptLabel: "What do you do?",
                choices: [
                    {
                        text: "Leave immediately to avoid being locked out.",
                        nextScene: "walk_intro",
                        effects: { hunger: 10, warmth: 0, spirit: 0 } 
                    },
                    {
                        text: "Stay to eat some bannock, risking lateness.",
                        nextScene: "walk_intro",
                        effects: { hunger: -20, warmth: 0, spirit: 5 }
                    },
                    {
                        text: "Speak to your grandmother in Michif before you go.",
                        nextScene: "walk_intro",
                        effects: { hunger: 5, warmth: 0, spirit: 15 }
                    }
                ]
            },

            // SCENE 2: THE WALK
            "walk_intro": {
                bg: "images/road.JPG",
                text: `I looked back at the shack one last time. It sits on that thirty-foot strip of dirt the government calls a road allowance, the only place they let us be. Momma tried to make me look nice, but I know what those people think when they look at us. They see "squatters." They see "filth." I just see the only home I’ve ever known, tucked away in the bush where we tried to stay hidden.`,
                nextScene: "walk_cold"
            },

            "walk_cold": {
                bg: "images/road.JPG",
                text: `Three miles. It feels longer when the wind cuts right through this coat. Momma fixed it up best she could but the noticeable holes in the fabric make it hard not to freeze.\n\nI keep my head down, watching my boots sink into the snow, trying to ignore the sting in my ears. I’m an "extern," that’s what they call us. Not a boarder, not fully part of the school, just someone walking in from the bush.`,
                nextScene: "walk_identity"
            },

            "walk_identity": {
                bg: "images/road.JPG",
                text: `I listened to Dad argue with the Indian Agent. It’s always the same. We are too "white" for the Treaty benefits, but too "Indian" for the town schools. I am a problem they don't know how to solve, so they just shuffle me around.`,
                nextScene: "walk_hope"
            },

            "walk_hope": {
                bg: "images/road.JPG",
                text: `Maybe this new school will be different?\n\nMaybe I can finally belong?`,
                nextScene: "arrival_scene" 
            },

            // SCENE 3: ARRIVAL
            "arrival_scene": {
                bg: "images/school2.jpg", 
                effects: { spirit: -25, hunger: 15, warmth: -50 },
                text: `I finally arrive at the school, part of me feels comfort that I made it this far but part of me wishes I stayed back at home helping father chop some firewood to keep us through the night.`,
                nextScene: "arrival_father"
            },

            "arrival_father": {
                bg: "images/school2.jpg",
                text: `He's getting sicker by the day I can tell, but he won't show any sign of pain. I know he's looking out for our family but it hurts to see him like this. Momma tried bringing him to the hospital but he was turned away and called a "filthy half-breed."`,
                nextScene: "arrival_locked_out"
            },

            "arrival_locked_out": {
                bg: "images/school2.jpg",
                text: `I look up and realize that I arrived early. The wind is biting at my nose, but the heavy wooden doors are shut tight. Through the frosted glass, I can see the yellow glow of the lamps in the hallway. It looks warm in there. But we are ‘externs.’ That’s the word they use for us. It means we don't belong inside until they ring the bell. It doesn't matter that my toes are numb or that the walk from the road allowance took an hour. To them, being early just means we wait in the snow.`,
                nextScene: "arrival_waiting"
            },

            "arrival_waiting": {
                bg: "images/school2.jpg",
                text: `The Sisters of Charity say we clutter the halls if we come in before morning prayer. I must wait.`,
                specialAction: "triggerTimeSkip"
            },

            // --- SCENE 4: ENTER THE NUN ---
            "school_entry": { 
                bg: "images/school2.jpg",
                // CHARACTER SWAP: Switch to Nun
                characterImg: "images/nun.png",
                text: "Finally, the bell rings and the heavy doors clank open. A Sister of Charity stands in the doorway, blocking the warmth from escaping.", 
                nextScene: "nun_dialogue_1"
            },

            "nun_dialogue_1": {
                bg: "images/school2.jpg",
                characterImg: "images/nun.jpg",
                text: `Finally. Get in, get in. Don't drag that snow onto the floor. You half-breeds are always lurking about. Wipe your feet. You're lucky we let you in at all.`,
                nextScene: "nun_dialogue_2"
            },

            "nun_dialogue_2": {
                bg: "images/school2.jpg",
                characterImg: "images/nun.jpg",
                text: `The government doesn't pay a cent for you to be here, you know. You are here out of charity, so try to look less like a savage and more like a student.`,
                // End of current demo loop
                promptLabel: "End of Demo",
                choices: [
                    { text: "Restart", action: "exitGame" }
                ]
            }
        };

        // --- ENGINE FUNCTIONS ---

        function typeWriter(text, elementId, callback) {
            const element = document.getElementById(elementId);
            element.innerHTML = ""; 
            state.isTyping = true;
            document.getElementById('continuePrompt').style.visibility = 'hidden'; 

            let i = 0;
            function type() {
                if (i < text.length) {
                    if (text.charAt(i) === '<') {
                        let tag = '';
                        while (text.charAt(i) !== '>' && i < text.length) {
                            tag += text.charAt(i);
                            i++;
                        }
                        tag += '>';
                        i++;
                        element.innerHTML += tag;
                    } else {
                        element.innerHTML += text.charAt(i);
                        i++;
                    }
                    typeTimeouts.push(setTimeout(type, typeSpeed));
                } else {
                    state.isTyping = false;
                    document.getElementById('continuePrompt').style.visibility = 'visible';
                    if (callback) callback();
                }
            }
            type();
        }

        function clearTypewriter() {
            typeTimeouts.forEach(timeout => clearTimeout(timeout));
            typeTimeouts = [];
            state.isTyping = false;
            document.getElementById('continuePrompt').style.visibility = 'visible';
        }

        function playIntroNext() {
             document.getElementById('choices-overlay').style.display = 'none';

            if (state.isTyping) {
                clearTypewriter();
                document.getElementById('story-text').innerHTML = introSequence[state.introIndex];
                return;
            }

            state.introIndex++;

            if (state.introIndex < introSequence.length) {
                typeWriter(introSequence[state.introIndex], 'story-text');
            } else {
                state.inIntro = false;
                showScene("ready_check");
            }
        }

        function showScene(sceneId) {
            const scene = storyData[sceneId];
            if (!scene) return alert("Error: Scene not found: " + sceneId);

            state.currentScene = scene; 
            state.waitingForInput = false; 

            // HANDLE CHARACTER SWAP
            const charImg = document.getElementById('character-sprite');
            
            if (scene.characterImg) {
                // If scene defines a specific character (e.g., Nun), use it
                // Only update if it's different to avoid flickering
                if (!charImg.src.includes(scene.characterImg)) {
                     charImg.style.opacity = 0; // Quick fade out
                     setTimeout(() => {
                         charImg.src = scene.characterImg;
                         charImg.style.opacity = 0.95; // Fade in
                     }, 200);
                }
            } else {
                // Revert to player default if no character defined
                let playerDefault = (state.gender === 'female') ? 'images/girl.png' : 'images/boy.png';
                if (!charImg.src.includes(playerDefault)) {
                    charImg.src = playerDefault;
                }
            }

            if (scene.effects) {
                applyStats(scene.effects);
            }

            let processedText = scene.text.replace("[Name]", state.name);

            if (scene.bg) {
                 const bgLayer = document.getElementById('bg-layer');
                 if (!bgLayer.style.backgroundImage.includes(scene.bg)) {
                     bgLayer.style.backgroundImage = `url('${scene.bg}')`;
                 }
            }

            typeWriter(processedText, 'story-text', () => {
                state.waitingForInput = true;
            });
        }

        function presentChoices(scene) {
            const overlay = document.getElementById('choices-overlay');
            const container = document.getElementById('choices-container');
            const promptLabel = document.getElementById('choice-prompt-text');
            
            container.innerHTML = ''; 
            promptLabel.innerText = scene.promptLabel || "Make a choice";

            scene.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerText = choice.text;
                
                if (choice.action === "exitGame") {
                     btn.onclick = () => window.location.href = 'index.html';
                } else {
                     btn.onclick = () => makeChoice(choice);
                }
                
                container.appendChild(btn);
            });
            
            overlay.style.display = 'flex';
        }

        function showNotification(changes) {
            let messages = [];
            
            if (changes.hunger) {
                if (changes.hunger > 0) messages.push(`<span style="color:#ff6b6b">Hunger increased by ${changes.hunger}%</span>`);
                else messages.push(`<span style="color:#51cf66">Hunger reduced by ${Math.abs(changes.hunger)}%</span>`);
            }
            
            if (changes.warmth) {
                if (changes.warmth < 0) messages.push(`<span style="color:#ff6b6b">Lost ${Math.abs(changes.warmth)}% Warmth</span>`);
                else messages.push(`<span style="color:#51cf66">Gained ${changes.warmth}% Warmth</span>`);
            }
            
            if (changes.spirit) {
                 if (changes.spirit < 0) messages.push(`<span style="color:#ff6b6b">Lost ${Math.abs(changes.spirit)}% Spirit</span>`);
                 else messages.push(`<span style="color:#51cf66">Gained ${changes.spirit}% Spirit</span>`);
            }

            if (messages.length > 0) {
                const note = document.getElementById('stat-notification');
                note.innerHTML = messages.join("<br>");
                note.style.opacity = 1;
                
                setTimeout(() => {
                    note.style.opacity = 0;
                }, 3000);
            }
        }

        function applyStats(effects) {
            showNotification(effects);
            state.hunger += (effects.hunger || 0);
            state.warmth += (effects.warmth || 0);
            state.spirit += (effects.spirit || 0);
            
            state.hunger = Math.max(0, Math.min(100, state.hunger));
            state.warmth = Math.max(0, Math.min(100, state.warmth));
            state.spirit = Math.max(0, Math.min(100, state.spirit));
            updateStatsUI();
        }

        function makeChoice(choice) {
            document.getElementById('choices-overlay').style.display = 'none'; 

            if (state.inIntro === false && document.getElementById('statsBar').style.display === 'none') {
                 document.getElementById('statsBar').style.display = 'flex';
            }

            if (choice.effects) {
                applyStats(choice.effects);
            }

            showScene(choice.nextScene);
        }

        // --- TIME SKIP LOGIC ---
        function triggerTimeSkip() {
            state.inTimeSkip = true;
            state.waitingForInput = false;
            
            document.getElementById('dialogue-container').style.opacity = 0;
            document.getElementById('statsBar').style.opacity = 0;
            
            const overlay = document.getElementById('time-skip-overlay');
            overlay.classList.add('overlay-active');
            
            setTimeout(() => {
                 applyStats({ hunger: 10, spirit: -10, warmth: -15 });
            }, 1000);

            overlay.onclick = function() {
                overlay.classList.remove('overlay-active');
                
                document.getElementById('dialogue-container').style.opacity = 1;
                document.getElementById('statsBar').style.opacity = 1;

                setTimeout(() => {
                     state.inTimeSkip = false;
                     showScene("school_entry"); 
                }, 1500);
                
                overlay.onclick = null; 
            };
        }


        function updateStatsUI() {
            document.getElementById('hunger-stat').innerText = state.hunger + "%";
            document.getElementById('warmth-stat').innerText = state.warmth + "%";
            document.getElementById('spirit-stat').innerText = state.spirit + "%";
        }

        function advanceGlobal(e) {
            if (e.target.tagName === 'BUTTON') return; 
            if (state.inTimeSkip) return; 

            if (state.inIntro) {
                playIntroNext();
                return;
            }

            if (state.isTyping) {
                clearTypewriter();
                state.waitingForInput = true;
                let txt = state.currentScene.text.replace("[Name]", state.name);
                document.getElementById('story-text').innerHTML = txt;
                return;
            }

            if (state.waitingForInput) {
                if (state.currentScene.specialAction === "triggerTimeSkip") {
                    triggerTimeSkip();
                } 
                else if (state.currentScene.choices) {
                    presentChoices(state.currentScene);
                    state.waitingForInput = false; 
                } 
                else if (state.currentScene.nextScene) {
                    showScene(state.currentScene.nextScene);
                }
            }
        }

        document.body.addEventListener('click', advanceGlobal);
        document.body.addEventListener('keydown', (e) => {
            if (e.code === 'Space') advanceGlobal(e);
        });

        // START
        typeWriter(introSequence[0], 'story-text');

    </script>
</body>
</html>